'use strict'

const fs = require('fs')
const path = require('path')
const async = require('async')
const svgSourceDir = path.join(__dirname, '..', 'svgs', 'icons')
const targetDir = path.join(__dirname, '..', '..', 'imports', 'ui', 'images', 'icons')
const mkdirp = require('mkdirp')

async.waterfall([
  makeTargetDir,
  findSvgs,
  createIndex,
  extractSvgs,
  createComponents
], function (err) {
  if (err) throw err
})

function makeTargetDir (next) {
  mkdirp(targetDir, () => next())
}

function findSvgs (next) {
  fs.readdir(svgSourceDir, (err, icons) => {
    next(err, icons.filter((i) => path.extname(i) === '.svg'))
  })
}

function extractSvgs (icons, next) {
  async.map(icons, function (icon, finish) {
    const readPath = path.join(svgSourceDir, icon)
    const fileName = icon.replace('.svg', '.jsx')
    fs.readFile(readPath, (err, def) => finish(err, {fileName, def}))
  }, next)
}

function createComponents (svgs, next) {
  async.map(svgs, function (svg, finish) {
    const writePath = path.join(targetDir, svg.fileName)
    const fileContent = wrap(svg)
      .trim()

    fs.writeFile(writePath, fileContent, finish)
  }, next)
}

function wrap (svg) {
  const ComponentName = toCamelCase(svg.fileName)
  const iconName = svg.fileName.replace('.jsx', '')

  // oh god my eyes
  const svgSource = svg.def.toString('utf8')
  const matches = svgSource.match(/width=["|'](\d+)(?:px)?["|']\sheight=["|'](\d+)(?:px)?["|']/)
  const width = matches[1] || 20
  const height = matches[2] || 20

  // what have i done
  let content = svgSource
    .replace('<?xml version="1.0" encoding="UTF-8"?>', '')
    .replace('<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">', '')
    .replace(/(<svg[^>]*)\swidth=["|']\d+(?:px)?["|']\sheight=["|']\d+(?:px)?["|']\s*/g, '$1 ')
    .trim()

  if (content.indexOf('viewBox') === -1) {
    const otherContent = content.match(/<svg([^>]*)>/)
    content = content
      .replace(/(<svg[^>]*>)/, `<svg ${otherContent[1].trim()} viewBox="0 0 ${width} ${height}">`)
  }

  content = content
    .replace(/<svg([^>]*)>/, '<svg $1 style="$' + '{svgStyle}">')

  return `// DO NOT EDIT! Generated by private/build/createSvgComponents.jsx
import React from 'react'
import { string as toStyleString } from 'to-style'

export default function ${ComponentName} (props) {
  const className = \`svg-icon svg-icon-${iconName} \${props.className ? props.className :''}\`
  const style = Object.assign({
    width: '${width}px',
    height: '${height}px'
  }, props.style ? props.style : {})
  const fill = style.fill ? style.fill : 'currentColor'
  const svgStyle = toStyleString(Object.assign({}, {
    fill: style.fill || 'currentColor'
  }, props.svgStyle))

  const spanProps = Object.assign({}, props)
  delete spanProps.svgStyle

  return (
    <span {...spanProps} style={style} className={className} dangerouslySetInnerHTML={{ __html: \`
${content}
  \` }}></span>
  )
}
`
}

function toCamelCase (slug) {
  return slug
    .split('-')
    .map((iconName) => iconName.charAt(0).toUpperCase() + iconName.slice(1))
    .join('')
    .replace('.svg', '')
    .replace('.jsx', '')
}

function createIndex (icons, next) {
  const writePath = path.join(targetDir, 'index.js')
  const index = [createListOfImports(icons), createListOfExports(icons)].join('')
  fs.writeFile(writePath, index, (err) => next(err, icons))
}

function createListOfImports (icons) {
  return icons.reduce((imp, icon) => {
    imp += `import ${toCamelCase(icon)} from './${icon.replace('.svg', '.jsx')}'\n`
    return imp
  }, '')
}

function createListOfExports (icons) {
  return icons.reduce((exp, icon, i) => {
    exp += '  '
    exp += toCamelCase(icon)
    if (i !== icons.length - 1) exp += ',\n'
    if (i === icons.length - 1) exp += '\n}\n'
    return exp
  }, 'export {\n')
}
